<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>mdiki Preview</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/TetsuakiBaba/MarkPaper/markpaper.css">
    <style>
        body {
            max-width: none;
            margin: 0;
            padding: 0;
            background-color: white;
            font-family: sans-serif;
        }

        .preview-pane {
            height: 100vh;
            overflow-y: auto;
        }

        .preview-content {
            max-width: 38em;
            margin: 0 auto;
            padding: 40px 20px;
        }
    </style>
</head>

<body>
    <div class="preview-pane">
        <article id="preview" class="preview-content"></article>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/TetsuakiBaba/MarkPaper/markpaper.js" crossorigin="anonymous"
        type="text/javascript"></script>
    <script>
        (function () {
            const preview = document.getElementById('preview');
            const pane = document.querySelector('.preview-pane');
            let isScrollingFromParent = false;
            let scrollTimeout;

            // MarkPaperの動的要素（ハンバーガーメニュー等）を初期化
            if (window.MarkPaper && MarkPaper.createDynamicElements) {
                MarkPaper.createDynamicElements();
                MarkPaper.initHamburgerMenu();
            }

            function updatePreview(markdown) {
                if (typeof mdToHTML === 'function') {
                    // MarkPaperのグローバル関数を使用して変換
                    const html = mdToHTML(markdown);
                    preview.innerHTML = html;

                    // 目次を生成
                    if (window.MarkPaper && MarkPaper.generateTableOfContents) {
                        MarkPaper.generateTableOfContents();
                    }

                    // コードブロックのコピーボタン機能を適用
                    if (window.MarkPaper && MarkPaper.addCopyButtonFunctionality) {
                        MarkPaper.addCopyButtonFunctionality();
                    }

                    // 画像クリックでモーダル表示
                    preview.querySelectorAll('img').forEach(img => {
                        img.style.cursor = 'zoom-in';
                        img.onclick = () => {
                            window.parent.postMessage({
                                type: 'show_image',
                                src: img.src,
                                name: img.alt || img.src.split('/').pop()
                            }, '*');
                        };
                    });
                }
            }

            // 親ウィンドウからのメッセージ待機
            window.addEventListener('message', function (event) {
                if (!event.data) return;

                if (event.data.type === 'update') {
                    updatePreview(event.data.content);
                } else if (event.data.type === 'scroll') {
                    // 親（エディタ）からのスクロール同期
                    isScrollingFromParent = true;
                    const maxScroll = pane.scrollHeight - pane.clientHeight;
                    pane.scrollTop = event.data.percent * maxScroll;
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        isScrollingFromParent = false;
                    }, 100);
                }
            });

            // プレビュー側のスクロールをエディタに同期
            pane.addEventListener('scroll', () => {
                if (isScrollingFromParent) return;
                const maxScroll = pane.scrollHeight - pane.clientHeight;
                const percent = maxScroll > 0 ? pane.scrollTop / maxScroll : 0;
                window.parent.postMessage({
                    type: 'scroll',
                    percent: percent
                }, '*');
            });

            // 準備完了を通知
            window.parent.postMessage('preview_ready', '*');
        })();
    </script>
</body>

</html>